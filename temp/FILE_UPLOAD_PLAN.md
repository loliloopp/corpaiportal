# План внедрения отправки файлов

## Общее описание

План состоит из двух этапов:

1.  **Фронтенд**: Добавление UI для загрузки файлов, обработка файлов на клиенте и обновление формата сообщений.
2.  **Бэкенд (прокси)**: Адаптация API для приёма нового формата сообщений с файлами.

Изменения коснутся только моделей `gpt-5-mini` и `gpt-5`, которые поддерживают vision-возможности.

---

### Этап 1: Фронтенд

#### 1. Обновление структур данных

**Задача**: Адаптировать тип `Message` для поддержки мультимодального контента (текст + изображения).

**Файл**: `src/entities/chat/model/types.ts`

**Алгоритм**:

- Изменить поле `content` в интерфейсе `Message`, чтобы оно могло принимать либо строку, либо массив объектов.
- Объекты в массиве будут иметь тип `text` или `image_url`.
```typescript
export interface Message {
  // ...другие поля
  content: string | Array<{
    type: 'text';
    text: string;
  } | {
    type: 'image_url';
    image_url: {
      url: string; // data:image/jpeg;base64,...
    };
  }>;
  // ...другие поля
}
```


#### 2. Создание UI для загрузки файлов

**Задача**: Добавить кнопку для прикрепления файлов в форму ввода чата.

**Файл**: `src/features/chat-input/index.tsx`

**Алгоритм**:

- Добавить иконку-кнопку (например, `PaperClipOutlined`) рядом с кнопкой отправки.
- При клике на иконку программно вызывать скрытый `<input type="file" accept="image/*">`.
- Выбранные файлы сохранять в локальном состоянии компонента.
- Отображать миниатюры прикреплённых изображений под полем ввода текста.
- Добавить кнопку для удаления прикреплённых файлов перед отправкой.

#### 3. Обновление логики отправки сообщений

**Задача**: Научить `chat-store` обрабатывать и отправлять сообщения с файлами.

**Файл**: `src/entities/chat/model/chat-store.ts`

**Алгоритм**:

- Модифицировать действие `sendMessage`, чтобы оно принимало опциональный массив файлов.
- Внутри `sendMessage`:
  - Если файлы прикреплены, для каждого файла:
    - Считать его как `Data URL` (base64) с помощью `FileReader`.
  - Сформировать полезную нагрузку `content` в виде массива, содержащего текст и `image_url` для каждого изображения.
- `optimisticUserMessage` будет создаваться с новой структурой `content`.

#### 4. Обновление UI для отображения изображений в чате

**Задача**: Отображать отправленные изображения в истории сообщений.

**Файл**: `src/entities/chat/ui/chat-message.tsx`

**Алгоритм**:

- В компоненте `ChatMessage` добавить логику рендеринга:
  - Если `message.content` — это массив, итерировать по нему.
  - Текстовые части отображать как текст.
  - Части с `image_url` отображать как `<img>` с `src`, равным `dataURL`.

---

### Этап 2: Бэкенд (прокси)

#### 1. Адаптация Chat Endpoint

**Задача**: Убедиться, что прокси-сервер корректно обрабатывает новый формат сообщений.

**Файл**: `proxy/src/index.ts` (эндпоинт `/api/v1/chat`)

**Алгоритм**:

- Проверить логику "очистки" сообщений `cleanedMessages`.
- Текущая логика `messages.map(msg => ({ role: msg.role, content: msg.content }))` должна корректно работать, так как она сохраняет поле `content` "как есть".
- Если `content` приходит в виде массива (мультимодальный контент), он будет правильно передан AI-провайдеру (OpenAI/OpenRouter), так как это соответствует их API.
- **Никаких изменений в коде прокси не потребуется**, если клиент будет отправлять корректную структуру.

---

### Этап 3: Тестирование

**Задача**: Проверить работоспособность новой функции.

**Алгоритм**:

1. Выбрать модель `gpt-5-mini`.
2. Прикрепить изображение и написать текстовый запрос (например, "Что на этом изображении?").
3. Отправить сообщение.
4. Убедиться, что:

   - Запрос на прокси содержит массив в поле `content`.
   - Прокси успешно перенаправляет запрос.
   - Ответ от AI получен и отображается в чате.
   - Отправленное изображение видно в истории переписки.

---

**Дата создания**: октябрь 2025  
**Статус**: Ожидание подтверждения
