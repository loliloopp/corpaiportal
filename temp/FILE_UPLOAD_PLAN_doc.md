# План внедрения анализа документов Office, PDF и TXT

## Общее описание

Этот план описывает внедрение функции загрузки документов (`.docx`, `.xlsx`, `.pdf`, `.txt`). Ключевая особенность — **извлечение текста происходит на стороне клиента (в браузере)**, после чего чистый текст отправляется в чат для анализа языковой моделью. Это позволяет избежать необходимости в хранилище файлов и делает функцию совместимой с любой текстовой моделью.

---

### Этап 1: Фронтенд

#### 1. Установка зависимостей

**Задача**: Добавить библиотеки для парсинга файлов в браузере.

**Алгоритм**:

- Выполнить команду для установки необходимых пакетов:
  ```bash
  npm install mammoth xlsx pdfjs-dist
  ```

- `mammoth`: для извлечения текста из `.docx`.
- `xlsx`: для извлечения текста из `.xlsx`.
- `pdfjs-dist`: для извлечения текста из `.pdf`.

#### 2. Создание утилиты для парсинга файлов

**Задача**: Создать централизованную функцию для извлечения текста из разных типов файлов.

**Файл**: `src/shared/lib/file-parser.ts` (новый файл)

**Алгоритм**:

- Создать асинхронную функцию `extractTextFromFile(file: File): Promise<string>`.
- Внутри функции, в зависимости от типа файла (`file.type` или расширения), вызывать соответствующий парсер:
  - **.txt**: Использовать `FileReader API`.
  - **.docx**: Использовать `mammoth.extractRawText({ arrayBuffer: ... })`.
  - **.xlsx**: С помощью `xlsx` итерировать по всем листам и ячейкам, собирая их содержимое в одну строку.
  - **.pdf**: Использовать `pdfjs-dist` для загрузки документа и последовательного извлечения текста с каждой страницы.
- Функция должна возвращать весь извлечённый текст в виде единой строки.

#### 3. Обновление интерфейса чата

**Задача**: Адаптировать компонент ввода для загрузки документов.

**Файл**: `src/features/chat-input/index.tsx`

**Алгоритм**:

- Изменить `<input type="file">`, добавив поддержку новых форматов: `accept=".txt,.pdf,.docx,.xlsx"`.
- После выбора файла отображать его имя и иконку для удаления под полем ввода.
- Во время парсинга файла показывать индикатор загрузки (`Spin`), чтобы пользователь понимал, что идёт обработка.
- Блокировать кнопку отправки на время парсинга.

#### 4. Обновление логики отправки сообщения

**Задача**: Интегрировать извлечённый текст в отправляемое сообщение.

**Файл**: `src/features/chat-input/index.tsx` (локальное состояние)

**Алгоритм**:

- При выборе файла вызывать утилиту `extractTextFromFile`.
- Сохранять извлечённый текст в локальном состоянии компонента.
- При отправке сообщения (`handleSendMessage`) формировать финальный текст по шаблону:
  ```
  --- НАЧАЛО КОНТЕКСТА ИЗ ФАЙЛА: {имя файла} ---
  {...весь извлечённый текст...}
  --- КОНЕЦ КОНТЕКСТА ИЗ ФАЙЛА ---

  {вопрос пользователя из поля ввода}
  ```

- Эта большая строка будет отправлена в `chat-store` как обычное текстовое сообщение. Структура `Message` не меняется.

---

### Этап 2: Бэкенд (Прокси)

**Задача**: Убедиться, что прокси готов к приёму длинных сообщений.

**Файл**: `proxy/src/index.ts`

**Алгоритм**:

- **Никаких изменений в коде не требуется.** Логика прокси уже готова пересылать текстовые сообщения любой длины.
- **Важно учесть**: Во время тестирования нужно будет проверить, нет ли у Nginx или Express ограничений на максимальный размер тела POST-запроса, так как извлечённый текст может быть очень большим.

---

### Этап 3: Тестирование

**Задача**: Проверить полную работоспособность новой функции.

**Алгоритм**:

1. Поочерёдно загрузить и отправить на анализ файлы каждого типа: `.txt`, `.docx`, `.xlsx`, `.pdf`.
2. Проверить работу с файлами разного размера (маленький и большой, ~1-2 МБ), обращая внимание на скорость парсинга в браузере.
3. Убедиться, что извлечённый текст корректно добавляется к запросу.
4. Убедиться, что ответ модели соответствует содержимому документа.

### To-dos

- [ ] Install dependencies for parsing documents (`mammoth`, `xlsx`, `pdfjs-dist`).
- [ ] Create a file parsing utility (`src/shared/lib/file-parser.ts`) to extract text from different file types.
- [ ] Update the chat input UI in `src/features/chat-input/index.tsx` to handle document uploads, display file info, and show a loading state.
- [ ] Implement the logic in `src/features/chat-input/index.tsx` to call the parser and prepend extracted text to the user's message before sending.
- [ ] Test the end-to-end functionality with various document types and sizes.
